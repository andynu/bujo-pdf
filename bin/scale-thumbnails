#!/usr/bin/env ruby
# frozen_string_literal: true

# Scale existing docs PNG images to thumbnails for embedding
#
# This script takes the full-resolution images from docs/ (generated by
# bin/generate-samples) and scales them down to thumbnail size for
# embedding in visual TOC pages.
#
# Usage:
#   bin/scale-thumbnails                    # Scale all docs/*.png
#   bin/scale-thumbnails --size 100         # Custom thumbnail width

require 'fileutils'

DOCS_DIR = File.expand_path('../docs', __dir__)
THUMBNAIL_DIR = File.expand_path('../assets/thumbnails', __dir__)
DEFAULT_SIZE = 80

def main(args)
  size = DEFAULT_SIZE

  # Parse args
  i = 0
  while i < args.length
    case args[i]
    when '--help', '-h'
      show_help
      return
    when '--size', '-s'
      i += 1
      size = args[i].to_i
    end
    i += 1
  end

  FileUtils.mkdir_p(THUMBNAIL_DIR)

  puts "Scaling docs images to #{size}px thumbnails..."
  puts

  Dir.glob(File.join(DOCS_DIR, '*.png')).each do |source|
    name = File.basename(source)
    dest = File.join(THUMBNAIL_DIR, name)

    print "  #{name}... "

    cmd = "convert '#{source}' -resize #{size}x '#{dest}'"
    if system(cmd, err: File::NULL)
      size_kb = (File.size(dest) / 1024.0).round(1)
      puts "OK (#{size_kb} KB)"
    else
      puts "FAILED"
    end
  end

  puts
  puts "Thumbnails saved to: #{THUMBNAIL_DIR}"
end

def show_help
  puts <<~HELP
    bin/scale-thumbnails - Scale docs images to thumbnails

    Usage:
      bin/scale-thumbnails [OPTIONS]

    Options:
      --size, -s NUM      Thumbnail width in pixels (default: #{DEFAULT_SIZE})
      --help, -h          Show this help message

    This script scales images from docs/ (generated by bin/generate-samples)
    to thumbnail size for embedding in visual TOC pages.

    Example:
      bin/generate-samples          # Generate full-res docs images first
      bin/scale-thumbnails          # Scale to thumbnails
  HELP
end

main(ARGV)
