#!/usr/bin/env ruby
# frozen_string_literal: true

# Generate sample page images for documentation
#
# This script:
# 1. Generates a PDF planner for the current year
# 2. Extracts one page of each page type as PNG images
# 3. Saves images to docs/ folder for README reference

require 'fileutils'
require 'date'

YEAR = Date.today.year
PDF_FILE = "planner_#{YEAR}.pdf"
DOCS_DIR = File.expand_path('../docs', __dir__)
DPI = 150  # Resolution for PNG output

# Page numbers (1-indexed as they appear in PDF)
PAGES = {
  'seasonal_calendar' => 1,
  'year_events' => 2,
  'multi_year_overview' => 4,
  'weekly' => 10,  # Pick a week in the middle
  'reference' => -2,  # Second to last page
  'blank_dots' => -1  # Last page
}

puts "Generating sample images for planner documentation..."
puts

# Step 1: Generate the PDF
puts "1. Generating PDF for #{YEAR}..."
system("bundle exec bin/bujo-pdf #{YEAR}") || abort("Failed to generate PDF")
abort("PDF file not found: #{PDF_FILE}") unless File.exist?(PDF_FILE)
puts "   ✓ Generated #{PDF_FILE}"
puts

# Step 2: Create docs directory
FileUtils.mkdir_p(DOCS_DIR)
puts "2. Creating docs directory..."
puts "   ✓ #{DOCS_DIR}"
puts

# Step 3: Get total page count
page_count = `identify -format "%n\n" #{PDF_FILE}`.lines.first.to_i
puts "3. PDF has #{page_count} pages"
puts

# Step 4: Extract pages to PNG
puts "4. Extracting sample pages..."
PAGES.each do |name, page_num|
  output_file = File.join(DOCS_DIR, "#{name}.png")

  # Convert negative page numbers to actual page numbers
  actual_page = if page_num < 0
                  page_count + page_num + 1  # -1 becomes last, -2 becomes second to last
                else
                  page_num
                end

  # ImageMagick uses 0-indexed pages
  page_arg = "#{PDF_FILE}[#{actual_page - 1}]"

  cmd = "convert -density #{DPI} #{page_arg} -quality 90 #{output_file}"

  print "   Extracting page #{actual_page} (#{name})... "
  system(cmd, err: File::NULL) || abort("\n   ✗ Failed to convert #{name}")
  puts "✓"
end
puts

# Step 5: Show results
puts "5. Results:"
PAGES.keys.each do |name|
  file_path = File.join(DOCS_DIR, "#{name}.png")
  size_kb = (File.size(file_path) / 1024.0).round(1)
  puts "   ✓ #{name}.png (#{size_kb} KB)"
end
puts

puts "Sample images saved to: #{DOCS_DIR}"
puts
puts "You can now reference these in README.md:"
PAGES.keys.each do |name|
  puts "![#{name.split('_').map(&:capitalize).join(' ')}](docs/#{name}.png)"
end
